<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SWE Week Financial Planning Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#105652',
                        'secondary-gold': '#ffcc00',
                        'accent-green': '#34d399',
                        'dark-gray': '#1f2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .summary-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }
        .summary-card:hover {
            transform: translateY(-2px);
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        th {
            background-color: #f3f4f6;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        .table-container {
            max-height: 70vh; /* Limits table height for better visibility */
            overflow-y: auto;
        }
        /* Style for the Export Button's focus and active state */
        #export-btn:focus, #export-btn:active {
            outline: none;
            box-shadow: 0 0 0 4px rgba(52, 211, 153, 0.5);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-primary-blue mb-2">SWE Week Procurement & Budget Tracker</h1>
            <p class="text-lg text-gray-600">Final analysis and interactive tracking log consolidated from all 7 documents.</p>
        </header>

        <!-- Dynamic Summary Section -->
        <div id="summary-section" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
            <!-- Content will be injected by JavaScript -->
        </div>

        <!-- Unpriced Procurement List -->
        <div class="bg-white rounded-xl p-6 mb-12 summary-card">
            <h2 class="text-2xl font-bold text-dark-gray mb-4 border-b pb-2">Required Procurement Items Needing Quotes (N/A Cost)</h2>
            <ul id="unpriced-list" class="list-disc list-inside space-y-1 text-gray-700">
                <!-- Content will be injected by JavaScript -->
            </ul>
        </div>

        <div class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white rounded-xl p-4 shadow-md">
            <h2 class="text-2xl font-bold text-dark-gray mb-4 md:mb-0">Interactive Procurement Log (55 Items)</h2>
            <div class="flex flex-col sm:flex-row gap-3">
                <select id="filter-type" class="p-2 border border-gray-300 rounded-lg text-sm">
                    <option value="All">Filter by Type (All)</option>
                    <option value="Procurement">Procurement</option>
                    <option value="Cost Projection">Cost Projection</option>
                    <option value="Labor/Stipend">Labor/Stipend</option>
                    <option value="Revenue">Revenue</option>
                </select>
                <select id="filter-cost" class="p-2 border border-gray-300 rounded-lg text-sm">
                    <option value="All">Filter by Cost Status (All)</option>
                    <option value="Priced">Priced (₦)</option>
                    <option value="Unpriced">Unpriced (N/A)</option>
                </select>
                <button id="export-btn" class="bg-accent-green hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 shadow-md">
                    Export Log to CSV
                </button>
            </div>
        </div>

        <!-- Main Interactive Log Table -->
        <div class="bg-white rounded-xl shadow-xl overflow-hidden mb-8">
            <div class="table-container">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="checkbox-cell">Done</th>
                            <th>ID</th>
                            <th>Description</th>
                            <th>Event Phase</th>
                            <th>Cost Type</th>
                            <th>Projected Cost (₦)</th>
                        </tr>
                    </thead>
                    <tbody id="procurement-log" class="divide-y divide-gray-100">
                        <!-- Table rows will be inserted by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- DATA INPUT: FINAL CONSOLIDATED LOG ---
        const initialData = [
            // JAVINEER Hackathon (1.x)
            { id: '1.1', type: 'Procurement', description: 'Daily Stand-Up Setup', event: 'JAVINEER Setup', cost: 8000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.2', type: 'Procurement', description: 'Command Center Desk', event: 'JAVINEER Setup', cost: 12000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.3', type: 'Procurement', description: 'Volunteer Roster Printing & Badges', event: 'JAVINEER Setup', cost: 7000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.4', type: 'Procurement', description: 'Progress Tracker Board', event: 'JAVINEER Setup', cost: 6000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.5', type: 'Procurement', description: 'Workspace Zoning & Signage (10 signs)', event: 'JAVINEER Setup', cost: 5000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.6', type: 'Procurement', description: 'Power Extension Units (10 units)', event: 'JAVINEER Setup', cost: 45000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.7', type: 'Procurement', description: 'Fan / Ventilation Support (6 units)', event: 'JAVINEER Setup', cost: 42000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.8', type: 'Procurement', description: 'Cleaning & Maintenance Supplies (1 day)', event: 'JAVINEER Setup', cost: 10000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.9', type: 'Procurement', description: 'Primary Wi-Fi Bundle / Router (2 units)', event: 'JAVINEER Tech', cost: 40000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.10', type: 'Procurement', description: 'Backup Internet Plan (1 device)', event: 'JAVINEER Tech', cost: 15000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.11', type: 'Cost Projection', description: 'Power Backup Fuel (20 litres)', event: 'JAVINEER Tech', cost: 19000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.12', type: 'Procurement', description: 'Technical Support Desk Setup', event: 'JAVINEER Tech', cost: 10000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.13', type: 'Cost Projection', description: 'Developer Tool Access / API Credits (4 teams)', event: 'JAVINEER Tech', cost: 20000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.14', type: 'Labor/Stipend', description: 'Mentor Allowance (6 mentors)', event: 'JAVINEER Labor', cost: 45000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.15', type: 'Procurement', description: 'Mentor Resource Pack (6 packs)', event: 'JAVINEER Labor', cost: 6000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.16', type: 'Procurement', description: 'Device / Equipment Backup (2 laptops + cables)', event: 'JAVINEER Tech', cost: 15000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.17', type: 'Procurement', description: 'Technical Session Materials (20 copies)', event: 'JAVINEER Setup', cost: 4000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.18', type: 'Cost Projection', description: 'Breakfast (Saturday) - 30 persons', event: 'JAVINEER Catering', cost: 36000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.19', type: 'Cost Projection', description: 'Lunch (Saturday) - 30 persons', event: 'JAVINEER Catering', cost: 60000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.20', type: 'Cost Projection', description: 'Dinner (Saturday) - 30 persons', event: 'JAVINEER Catering', cost: 54000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.21', type: 'Cost Projection', description: 'Snacks & Hydration (throughout)', event: 'JAVINEER Catering', cost: 20000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.22', type: 'Procurement', description: 'Welfare Desk Supplies (disposables)', event: 'JAVINEER Welfare', cost: 10000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.23', type: 'Procurement', description: 'Recreation Block (Board games, music)', event: 'JAVINEER Welfare', cost: 10000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.24', type: 'Cost Projection', description: 'Volunteer Meal Support (10 meals)', event: 'JAVINEER Catering', cost: 12000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.25', type: 'Procurement', description: 'Rest Zone Setup (Mats, pillows, 8 sets)', event: 'JAVINEER Welfare', cost: 24000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.26', type: 'Procurement', description: 'Health & Safety Station (First-aid kit)', event: 'JAVINEER Welfare', cost: 8000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.27', type: 'Labor/Service', description: 'Photographer / Videographer (Full-day coverage)', event: 'JAVINEER Media', cost: 30000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.28', type: 'Labor/Service', description: 'Highlight Video Production (48 hrs delivery)', event: 'JAVINEER Media', cost: 15000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.29', type: 'Labor/Stipend', description: 'Live Coverage Assistant (1 person)', event: 'JAVINEER Media', cost: 5000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.30', type: 'Labor/Stipend', description: 'Social Media Content Team (2 students)', event: 'JAVINEER Media', cost: 10000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.31', type: 'Procurement', description: 'Interview / Mic Setup', event: 'JAVINEER Media', cost: 10000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.32', type: 'Procurement', description: 'Backdrop & Branding Frame (Reusable)', event: 'JAVINEER Media', cost: 20000, costType: 'CAPEX', status: 'Priced', done: false },
            { id: '1.33', type: 'Labor/Service', description: 'Drone / Aerial Shots (Optional)', event: 'JAVINEER Media', cost: 15000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.34', type: 'Procurement', description: 'Printing & Materials (Photo board, posters)', event: 'JAVINEER Media', cost: 7500, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.35', type: 'Labor/Service', description: 'Daily Recap Blog / Report (1 writer)', event: 'JAVINEER Media', cost: 7500, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.36', type: 'Procurement', description: 'Projector & Screen Rental (Demo & Exit)', event: 'JAVINEER Demo', cost: 15000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.37', type: 'Procurement', description: 'Public Address System Rental (Demo & Exit)', event: 'JAVINEER Demo', cost: 10000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.38', type: 'Procurement', description: 'Stationery (Score Sheets, Pens, Files)', event: 'JAVINEER Demo', cost: 6000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.39', type: 'Procurement', description: 'Award Plaques (Top 3 winning teams)', event: 'JAVINEER Demo', cost: 21000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '1.40', type: 'Procurement', description: 'Certificates Printing (Participant recognition)', event: 'JAVINEER Demo', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '1.41', type: 'Cost Projection', description: 'PHASE TOTAL: Demo & Exit', event: 'JAVINEER Summary', cost: 237000, costType: 'Summary', status: 'Priced', done: false, excludeFromSum: true },
            
            // JAVINEER High-Level Budget (2.x) - Keep them as separate category summaries
            { id: '2.1', type: 'Cost Projection', description: 'Administrative Supplies (High-Level Budget)', event: 'JAVINEER Budget', cost: 150000, costType: 'Budget', status: 'Priced', done: false, excludeFromSum: true },
            { id: '2.2', type: 'Cost Projection', description: 'Branding & Promotion (High-Level Budget)', event: 'JAVINEER Budget', cost: 300000, costType: 'Budget', status: 'Priced', done: false, excludeFromSum: true },
            { id: '2.3', type: 'Cost Projection', description: 'Technical Equipment (High-Level Budget)', event: 'JAVINEER Budget', cost: 250000, costType: 'Budget', status: 'Priced', done: false, excludeFromSum: true },
            { id: '2.4', type: 'Cost Projection', description: 'Participant Kits (High-Level Budget)', event: 'JAVINEER Budget', cost: 150000, costType: 'Budget', status: 'Priced', done: false, excludeFromSum: true },
            { id: '2.5', type: 'Cost Projection', description: 'Food & Welfare (High-Level Budget)', event: 'JAVINEER Budget', cost: 250000, costType: 'Budget', status: 'Priced', done: false, excludeFromSum: true },
            { id: '2.6', type: 'Cost Projection', description: 'Media & Digital (High-Level Budget)', event: 'JAVINEER Budget', cost: 150000, costType: 'Budget', status: 'Priced', done: false, excludeFromSum: true },
            { id: '2.7', type: 'Cost Projection', description: 'Safety & Security (High-Level Budget)', event: 'JAVINEER Budget', cost: 100000, costType: 'Budget', status: 'Priced', done: false, excludeFromSum: true },
            { id: '2.8', type: 'Cost Projection', description: 'OVERALL GRAND TOTAL (High-Level Budget)', event: 'JAVINEER Summary', cost: 1200000, costType: 'Summary', status: 'Priced', done: false, excludeFromSum: true },
            
            // SWE WEEK Closing Ceremony (4.x)
            { id: '4.1', type: 'Cost Projection', description: 'Refreshment Packs (Dignitaries) - 20 persons', event: 'SWE Closing Catering', cost: 50000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '4.2', type: 'Cost Projection', description: 'Refreshment Packs (Speakers & Guests) - 40 persons', event: 'SWE Closing Catering', cost: 100000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '4.3', type: 'Cost Projection', description: 'Refreshment Packs (Participants & Volunteers) - 80 persons', event: 'SWE Closing Catering', cost: 120000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '4.4', type: 'Cost Projection', description: 'Refreshment Packs (Audience / Regular) - 200 persons', event: 'SWE Closing Catering', cost: 200000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '4.5', type: 'Cost Projection', description: 'Catering Contingency (10%)', event: 'SWE Closing Contingency', cost: 40000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '4.6', type: 'Cost Projection', description: 'REFRESHMENT GRAND TOTAL', event: 'SWE Closing Summary', cost: 460000, costType: 'Summary', status: 'Priced', done: false, excludeFromSum: true },

            // SWE WEEK EXPO (5.x)
            { id: '5.1', type: 'Cost Projection', description: 'Refreshments (Expo - Panelists/Guests/Team)', event: 'SWE EXPO Catering', cost: 360000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '5.2', type: 'Cost Projection', description: 'Rentals (Canopies, Chairs, Tables) for Field', event: 'SWE EXPO Setup', cost: 150000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '5.3', type: 'Procurement', description: 'Photo Booth (Grass carpet & props)', event: 'SWE EXPO Setup', cost: 50000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '5.4', type: 'Cost Projection', description: 'Contingency (9%) for Expo', event: 'SWE EXPO Contingency', cost: 50000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '5.5', type: 'Cost Projection', description: 'TOTAL ESTIMATED COST (Expo)', event: 'SWE EXPO Summary', cost: 610000, costType: 'Summary', status: 'Priced', done: false, excludeFromSum: true },
            { id: '5.6', type: 'Procurement', description: 'Panelist Setup (Round/Individual tables)', event: 'SWE EXPO Setup', cost: 'N/A', costType: 'CAPEX', status: 'Unpriced', done: false },
            { id: '5.7', type: 'Procurement', description: 'Panelist Supplies (Branded notebooks, pens)', event: 'SWE EXPO Setup', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '5.8', type: 'Procurement', description: 'Presentation Board and Markers', event: 'SWE EXPO Setup', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '5.9', type: 'Procurement', description: 'Air Conditioners/Fans (For ventilation)', event: 'SWE EXPO Setup', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '5.12', type: 'Revenue', description: 'Participation Fee (Per team)', event: 'SWE EXPO Revenue', cost: 15000, costType: 'Revenue', status: 'Priced', done: false, excludeFromSum: true },

            // SWE WEEK Opening Ceremony (6.x)
            { id: '6.1', type: 'Cost Projection', description: 'Rice (Catering Ingredient) - 5 measures', event: 'SWE Opening Catering', cost: 30000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.2', type: 'Cost Projection', description: 'Ingredient (Compressed necessities)', event: 'SWE Opening Catering', cost: 90000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.3', type: 'Cost Projection', description: 'Chicken (Main Meal) - 23 kg', event: 'SWE Opening Catering', cost: 172500, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.5', type: 'Cost Projection', description: 'Samosa (Snack)', event: 'SWE Opening Catering', cost: 94000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.6', type: 'Cost Projection', description: 'Spring Rolls (Snack)', event: 'SWE Opening Catering', cost: 52000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.7', type: 'Cost Projection', description: 'Meat Pie (Snack)', event: 'SWE Opening Catering', cost: 36000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.8', type: 'Cost Projection', description: 'Puff Puff (Snack)', event: 'SWE Opening Catering', cost: 15600, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.9', type: 'Cost Projection', description: 'Chicken (Snack)', event: 'SWE Opening Catering', cost: 172500, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.11', type: 'Procurement', description: 'Carbonated Drink (300 units)', event: 'SWE Opening Catering', cost: 90000, costType: 'OPEX', status: 'Priced', done: false },
            { id: '6.12', type: 'Procurement', description: 'Bottle Water (60 units - High Table)', event: 'SWE Opening Catering', cost: 12000, costType: 'OPEX', status: 'Priced', done: false },

            // Py-Kathon 2.0 (7.x)
            { id: '7.1', type: 'Procurement', description: 'Py-Kathon Registration Forms (4 per department)', event: 'Py-Kathon Setup', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '7.2', type: 'Labor/Stipend', description: 'Moderator (1 per department) Stipend', event: 'Py-Kathon Labor', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '7.3', type: 'Labor/Stipend', description: 'Coordinator Stipend (1 person)', event: 'Py-Kathon Labor', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '7.4', type: 'Labor/Stipend', description: 'Question Developer Stipend (1 person)', event: 'Py-Kathon Labor', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '7.5', type: 'Labor/Stipend', description: 'Technical Lead Stipend (GitHub Manager)', event: 'Py-Kathon Labor', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '7.6', type: 'Labor/Stipend', description: 'Chief Judge Stipend (1 person)', event: 'Py-Kathon Labor', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '7.7', type: 'Procurement', description: 'Designated Computer Laboratory Rental', event: 'Py-Kathon Setup', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
            { id: '7.8', type: 'Procurement', description: 'GitHub Repository Setup (Digital platform)', event: 'Py-Kathon Tech', cost: 'N/A', costType: 'OPEX', status: 'Unpriced', done: false },
        ];

        // Global state for filtered data
        let filteredData = initialData;

        // --- CORE FUNCTIONS ---

        function formatCurrency(amount) {
            if (amount === 'N/A') return 'N/A';
            if (typeof amount !== 'number') return 'Error';
            return '₦' + amount.toLocaleString('en-US');
        }

        function calculateMetrics() {
            let totalConfirmedBudget = 0;
            let unpricedItems = [];
            const costsByType = {};

            initialData.forEach(item => {
                // 1. Calculate Total Confirmed Budget (Excluding 'N/A' and designated Summary/Budget lines)
                if (typeof item.cost === 'number' && !item.excludeFromSum) {
                    totalConfirmedBudget += item.cost;
                }
                
                // 2. Identify Unpriced Items
                if (item.status === 'Unpriced') {
                    unpricedItems.push(item);
                }

                // 3. Group Costs by Event Phase
                const phase = item.event;
                if (!costsByType[phase]) {
                    costsByType[phase] = { total: 0, items: [] };
                }
                if (typeof item.cost === 'number' && !item.excludeFromSum) {
                    costsByType[phase].total += item.cost;
                }
                costsByType[phase].items.push(item);
            });

            return { totalConfirmedBudget, unpricedItems, costsByType };
        }

        function renderSummaries({ totalConfirmedBudget, unpricedItems, costsByType }) {
            const summarySection = document.getElementById('summary-section');
            const unpricedList = document.getElementById('unpriced-list');

            // Card 1: Total Confirmed Budget
            summarySection.innerHTML = `
                <div class="summary-card bg-primary-blue text-white rounded-xl p-6">
                    <p class="text-sm font-medium opacity-80 uppercase">Total Confirmed Line-Item Budget</p>
                    <h3 class="text-3xl font-extrabold mt-1">${formatCurrency(totalConfirmedBudget)}</h3>
                    <p class="text-xs opacity-70 mt-2">Excludes high-level budget estimates and revenue.</p>
                </div>
            `;

            // Card 2: Cost Grouping (Top 3 highest cost groups)
            const sortedCosts = Object.entries(costsByType)
                .filter(([key, value]) => !key.includes('Summary') && !key.includes('Budget') && value.total > 0)
                .sort(([, a], [, b]) => b.total - a.total)
                .slice(0, 3);

            let groupedHtml = '<p class="text-sm font-medium text-gray-500 uppercase">Top 3 Cost Groupings</p>';
            sortedCosts.forEach(([phase, data]) => {
                groupedHtml += `<p class="text-xl font-bold text-dark-gray mt-1">${formatCurrency(data.total)}</p>
                                <p class="text-xs text-gray-500 mb-2">${phase}</p>`;
            });

            summarySection.innerHTML += `
                <div class="summary-card bg-white rounded-xl p-6">
                    ${groupedHtml}
                </div>
            `;
             // Card 3: Summary of Unpriced/Labor Items
            summarySection.innerHTML += `
                <div class="summary-card bg-white rounded-xl p-6">
                    <p class="text-sm font-medium text-gray-500 uppercase">Unpriced Items (Quotes Needed)</p>
                    <h3 class="text-3xl font-extrabold text-red-500 mt-1">${unpricedItems.length}</h3>
                    <p class="text-xs text-gray-500 mt-2">Labor/Stipend & Procurement items without a price.</p>
                </div>
            `;


            // Render Unpriced List
            unpricedList.innerHTML = unpricedItems
                .map(item => `<li class="text-sm"><span class="font-semibold text-primary-blue">${item.id}</span>: ${item.description} (${item.event})</li>`)
                .join('');
        }

        function renderTable(data) {
            const tbody = document.getElementById('procurement-log');
            tbody.innerHTML = data.map(item => `
                <tr class="${item.cost === 'N/A' ? 'bg-yellow-50/50 hover:bg-yellow-50' : 'hover:bg-gray-50'}" data-type="${item.type}" data-cost-status="${item.status}">
                    <td class="checkbox-cell">
                        <input type="checkbox" onchange="toggleDone('${item.id}', this.checked)" class="h-5 w-5 text-accent-green rounded border-gray-300 focus:ring-accent-green" ${item.done ? 'checked' : ''}>
                    </td>
                    <td class="font-mono text-xs text-gray-500">${item.id}</td>
                    <td class="font-medium text-gray-900 w-2/5">${item.description}</td>
                    <td class="text-sm text-gray-600">${item.event}</td>
                    <td><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.costType === 'CAPEX' ? 'bg-blue-100 text-blue-800' : (item.costType === 'Revenue' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800')}">${item.costType}</span></td>
                    <td class="text-sm font-semibold ${item.status === 'Unpriced' ? 'text-red-500' : 'text-primary-blue'}">${formatCurrency(item.cost)}</td>
                </tr>
            `).join('');
        }

        function applyFilters() {
            const typeFilter = document.getElementById('filter-type').value;
            const costFilter = document.getElementById('filter-cost').value;

            filteredData = initialData.filter(item => {
                // Ignore summary/budget lines during filtering, but always show them if filters are 'All'
                if (item.costType === 'Summary' || item.costType === 'Budget') {
                    return typeFilter === 'All' && costFilter === 'All';
                }

                const matchesType = typeFilter === 'All' || item.type === typeFilter;
                const matchesCostStatus = costFilter === 'All' || item.status === costFilter;

                return matchesType && matchesCostStatus;
            });

            renderTable(filteredData);
        }

        function toggleDone(id, isChecked) {
            const item = initialData.find(i => i.id === id);
            if (item) {
                item.done = isChecked;
                // Optional: Re-render table to show state change, or rely on native checkbox state
            }
        }
        
        // --- EXPORT FUNCTION ---

        function exportToCSV() {
            const headers = ["Completed", "ID", "Description", "Event Phase", "Type", "Cost Type", "Projected Cost (₦)", "Notes"];
            
            // Prepare data rows (use ALL initialData, not just the filtered view)
            const csvRows = initialData.map(item => {
                let costStr = item.cost === 'N/A' ? 'N/A' : (typeof item.cost === 'number' ? item.cost.toString() : '');
                
                return [
                    item.done ? 'YES' : 'NO',
                    item.id,
                    item.description.replace(/"/g, '""'), // Escape quotes
                    item.event,
                    item.type,
                    item.costType,
                    costStr,
                    item.status === 'Unpriced' ? 'QUOTE NEEDED' : (item.costType === 'Summary' ? 'SUMMARY LINE' : '')
                ].map(field => `"${field}"`).join(','); // Enclose fields in quotes
            });

            // Combine headers and rows
            const csvContent = [
                headers.join(','),
                ...csvRows
            ].join('\n');

            // Copy to clipboard (best method for iframe/Canvas)
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = csvContent;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showClipboardSuccess();
                } else {
                    console.error('Copy command failed.');
                }
            } catch (err) {
                console.error('Error copying to clipboard: ', err);
            }
            document.body.removeChild(tempTextArea);
        }

        function showClipboardSuccess() {
            const exportBtn = document.getElementById('export-btn');
            const originalText = exportBtn.textContent;
            
            // Temporary change of button style
            exportBtn.textContent = 'Copied to Clipboard! (CSV)';
            exportBtn.classList.remove('bg-accent-green', 'hover:bg-green-600');
            exportBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');
            
            setTimeout(() => {
                exportBtn.textContent = originalText;
                exportBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                exportBtn.classList.add('bg-accent-green', 'hover:bg-green-600');
            }, 2000);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const metrics = calculateMetrics();
            renderSummaries(metrics);
            renderTable(initialData);

            document.getElementById('filter-type').addEventListener('change', applyFilters);
            document.getElementById('filter-cost').addEventListener('change', applyFilters);
            document.getElementById('export-btn').addEventListener('click', exportToCSV);
        });

    </script>
</body>
</html>
